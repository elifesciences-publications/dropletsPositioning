% removed some droplets from:
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample2\p1513852321_x9424.40_y-37592.70_Z00.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample2\p1513852328_x7675.10_y-35121.40_Z00.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample2\p1513852337_x6393.40_y-34921.10_Z00.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample2\p1513852338_x6439.90_y-35012.30_Z00.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample2\p1513852343_x7150.60_y-35479.40_Z00.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_20\sample2\p1513772178_x12074.60_y-41443.00_Z00.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix2 sample1\p1513858573_x6561.20_y-35573.20.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix2 sample1\p1513858575_x6516.30_y-37175.70.mat'
% 'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix2 sample1\p1513858582_x5358.90_y-40259.60.mat'

% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847575_x11239.60_y-39221.00_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847576_x11092.00_y-39103.60_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847577_x11222.40_y-39008.90_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847578_x11125.90_y-38811.90_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847579_x10920.10_y-38738.10_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847580_x10881.70_y-38392.50_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847582_x11184.90_y-37636.20_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847583_x11283.20_y-36914.00_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847585_x11038.00_y-36357.80_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847587_x11276.20_y-35964.90_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847589_x11269.00_y-35614.30_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847590_x11274.90_y-35402.20_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847591_x11397.60_y-35251.50_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847592_x11317.60_y-34812.50_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847595_x11609.80_y-34326.60_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847596_x11407.00_y-34242.40_Z00.mat
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847599_x9884.60_y-33709.30_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847600_x9498.40_y-33514.70_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847601_x9295.50_y-33540.30_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847602_x8972.00_y-33623.90_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847605_x8272.00_y-34187.50_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847607_x7508.90_y-37882.30_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847608_x7174.10_y-37847.70_Z00.mat 
% W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\p1513847610_x7669.20_y-34990.80_Z00.mat 

matDIR = {'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample2\',...
    'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix1 sample1\',...
    'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_20\sample2\',...
    'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2017_12_21\mix2 sample1\',...
    'W:\phkinnerets\storage\analysis\Niv\rambam5 extract\symmetry breaking analysis\2018_01_18\sample2'};
droplets=[];
check = {};

for dirNum = 1:length(matDIR)
    clear matFilenames
    matFs = ls(fullfile(matDIR{dirNum},'*.mat'));
    for i=1:size(matFs,1)
        matFilenames{i} = fullfile(matDIR{dirNum},matFs(i,:));
        d = load(matFilenames{i});
        addDroplets = [];
        for j=1:length(d.droplets)
            if ~isempty(d.droplets(j).aggregatePlane)
                addDroplets = [addDroplets, d.droplets(j)];
            end
        end
        if length(addDroplets) < 4;
            addDroplets = [];
        end
        if isempty(addDroplets)
            continue;
        end
        if mod(length(addDroplets),4) > 0
            check{end + 1} = matFilenames{i};
            display('1');
        else
            P = reshape([addDroplets.dropletPosition],4,[]);
            diam = P(3,:) * addDroplets(1).micronsPerPixel;
            for k =1:(length(addDroplets)/4)
                ind = 1+(4*(k-1)):4+(4*(k-1));
                diam = sort(diam);
                if max(diam(ind)) - min(diam(ind)) > 1
                    display('2');
                    check{end + 1} = matFilenames{i};
                end
            end
        end
        droplets = [droplets,addDroplets];
    end
end
% i = 1;
% while i < length(droplets)
%     if isempty(droplets(i).aggregatePlane)
%         droplets(i) = [];
%         i = i-1;
%     end
%     i = i+1;
% end

positions = reshape([droplets.dropletPosition],4,[]);
AggPositions = reshape([droplets.aggregatePosition],4,[]);
centeres = positions(1:2,:) + positions(3:4,:) / 2;
aggCenters = AggPositions(1:2,:) + AggPositions(3:4,:) / 2;
zDisplacement = ([droplets.dropletPlane] - [droplets.aggregatePlane]) * droplets(1).micronsPerPlane;

blobXYZ = [(aggCenters - centeres) * droplets(1).micronsPerPixel; zDisplacement];
dropRadius = positions(3,:) * droplets(1).micronsPerPixel / 2;
dropEffectiveRadius = dropRadius*(1 - (0.7^2/15/2)^(1/3));
blobVecErrorUp = blobXYZ;
blobVecErrorUp(3,:) = blobVecErrorUp(3,:) + droplets(1).micronsPerPlane;
blobVecErrorDown = blobXYZ;
blobVecErrorDown(3,:) = blobVecErrorDown(3,:) - droplets(1).micronsPerPlane;

blobRThetaPhi = myCart2sph(blobXYZ);
blobRThetaPhiErrUp = myCart2sph(blobVecErrorUp);
blobRThetaPhiErrDown = myCart2sph(blobVecErrorDown);
blobRError = sort([blobRThetaPhiErrUp(1,:); blobRThetaPhiErrDown(1,:)] - repmat(blobRThetaPhi(1,:),2,1));
times = [droplets.time];
blobDistance = blobRThetaPhi(1,:);
blobDistanceMinusPlus = [blobDistance;blobRError];
description = '';
clear dropVectors
TU = unique(times);
% % tzone = [50,90]; %initial time transition zone;
% tzone = [60,85]; %standard condition transition zone;
% seperators = [tzone(1),50;tzone(2),50];
seperators = -1;
for i=1:length(TU)
    T = TU(i);
    ind = find(times == T);
    dropVectors(i).blobXYZ = blobXYZ(:,ind);
    dropVectors(i).dropRadius = dropRadius(ind);
    dropVectors(i).description = sprintf('%d-%d minutes', T, T+5);
    dropVectors(i).dropEffectiveRadius = dropEffectiveRadius(ind);
    dropVectors(i).blobDistanceMinusPlus = blobDistanceMinusPlus(:,ind);
    [Fig(i), sectionsTime(i,:)] = scatter_displacement_paper2(dropVectors(i),true,seperators, format, outputDir);
%     histFig(i,:) = hist_symbreaking_paper(dropVectors(i),tzone);
end
% FigAll = scatter_displacement_time_paper(dropVectors',3,[30,110]);
if exist('format','var') && ischar(format) && exist('outputDir', 'var') && ischar(outputDir)
    for i=1:length(Fig)
        print(Fig(i),fullfile(outputDir,Fig(i).Name),format);
    end
end

FigTransitionRangeTime = figure('Position',[100 100 250 250]);
FigTransitionRangeTime.PaperPositionMode = 'auto';
ax = gca;
% plot([TU;TU],sectionsTime', 'b', 'lineWidth', 2);
% fill([TU,flip(TU)],[sectionsTime(:,1)',sectionsTime(:,2)'],'y');
secs = sectionsTime;
secs(:,3) = 60;
secs(:,2:3) = diff(secs,1,2);
h = area(TU,secs);
h(1).FaceColor = [253,226,226]./256;
h(2).FaceColor = [255,239,202]./256;
h(3).FaceColor = [233,243,221]./256;
ylim([15,60]);
xlim([TU(1),TU(end)]);
ax.XTick = TU;
xlabel('Time after sample preparation [min]');
ylabel('Transition size range [um]');
if exist('format','var') && ischar(format) && exist('outputDir', 'var') && ischar(outputDir)
    print(FigTransitionRangeTime,fullfile(outputDir,'FigTransitionRangeTime'),format);
end

